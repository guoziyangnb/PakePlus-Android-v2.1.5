import{B as V}from"./BackNavBar-B1Wem3l3.js";import{g as x,G as z,a as B,C as b,b as A}from"./version-GmJQqd8X.js";import{_ as U,m as g}from"./index-BsLNy1A6.js";import{i as v,f as p,l as M,g as e,p as _,t as h,I as C,h as w,R as N,o as m}from"./vendor-CLLCb1yY.js";function H(l,n){const o=l.replace(/^v/,""),a=n.replace(/^v/,""),s=o.split(".").map(Number),c=a.split(".").map(Number),d=Math.max(s.length,c.length);for(let r=0;r<d;r++){const f=s[r]||0,i=c[r]||0;if(f>i)return 1;if(f<i)return-1}return 0}async function G(){try{const l=x(z.owner,z.repo),n={Accept:"application/vnd.github.v3+json"};B&&(n.Authorization=`Bearer ${B}`);const o=await fetch(l,{headers:n});if(console.log("GitHub API 响应状态:",o.status),!o.ok){const i=await o.text();throw console.error("GitHub API 错误响应:",i),new Error(`GitHub API 请求失败: ${o.status} - ${i}`)}const a=await o.json(),s=a.tag_name;if(H(s,b)<=0)return null;const d=a.assets.find(i=>i.name.endsWith(".apk"));if(!d)return console.warn("Release 中未找到 APK 文件"),null;const r=d.browser_download_url,f=A?A+r:r;return{latestVersion:s,currentVersion:b,downloadUrl:f,fileSize:d.size,fileName:d.name,updateLog:a.body||a.name,releaseUrl:a.html_url,publishedAt:a.published_at}}catch(l){throw console.error("检查更新失败:",l),l}}function k(l){if(l===0)return"0 B";const n=1024,o=["B","KB","MB","GB"],a=Math.floor(Math.log(l)/Math.log(n));return Math.round(l/Math.pow(n,a)*100)/100+" "+o[a]}async function I(l,n,o){try{if(console.log("准备在新浏览器窗口打开下载链接:",l),o&&o(100,0,0),window.open(l,"_blank"))console.log("已在新窗口打开下载链接");else{console.warn("window.open 被阻止，尝试使用 <a> 标签方式");const s=document.createElement("a");s.href=l,s.target="_blank",s.rel="noopener noreferrer",s.style.display="none",document.body.appendChild(s),s.click(),setTimeout(()=>{document.body.removeChild(s)},100)}return}catch(a){throw console.error("下载 APK 失败:",a),a}}async function P(l,n){try{return await I(l.downloadUrl,l.fileName,n),console.log("下载完成，请查看浏览器下载列表"),!0}catch(o){throw console.error("下载安装失败:",o),o}}function D(l){const n=new Date(l),o=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0"),s=String(n.getDate()).padStart(2,"0");return`${o}-${a}-${s}`}function T(){localStorage.setItem("last_update_check",Date.now().toString())}const E={class:"page fade-in-up"},R={class:"container"},K={class:"current-version-card"},L={class:"version-info"},$={class:"version-number"},O={class:"check-section"},F={key:1,class:"checking-state"},j={key:2,class:"latest-version"},Y={key:3,class:"error-message"},W={key:0,class:"update-card"},X={class:"update-header"},q={class:"new-version"},J={class:"update-details"},Q={class:"detail-item"},Z={class:"detail-value"},ee={class:"detail-item"},se={class:"detail-value"},te={class:"update-log"},oe={class:"update-log-content"},ae={key:0,class:"download-section"},le=["href"],ne={key:1,class:"download-progress"},re={class:"progress-info"},ie={class:"progress-bar"},ce={class:"download-size-info"},de={key:2,class:"download-complete"},ue={__name:"AppUpdate",setup(l){const n=v(b),o=v(!1),a=v(!1),s=v(null),c=v(""),d=v(!1),r=v(0),f=v(0),i=v(!1),y=async()=>{o.value=!0,c.value="",s.value=null,i.value=!1;try{const u=await G();u?(s.value=u,g.success("发现新版本！")):g.success("已是最新版本"),T()}catch(u){console.error("检查更新失败:",u),c.value=u.message||"检查更新失败，请检查网络连接",g.error(u.message||"检查更新失败")}finally{o.value=!1,a.value=!0}},S=async()=>{d.value=!0,r.value=0,f.value=0;try{await P(s.value,(u,t,ve)=>{r.value=u,f.value=t}),i.value=!0,g.success("已打开浏览器下载页面，请在浏览器中完成下载")}catch(u){console.error("下载失败:",u),c.value="下载失败，请稍后重试",g.error("下载失败")}finally{d.value=!1}};return(u,t)=>(m(),p("div",E,[M(V,{title:"检查更新"}),e("div",R,[e("div",K,[t[1]||(t[1]=e("div",{class:"version-icon"},[e("svg",{viewBox:"0 0 24 24"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"})])],-1)),e("div",L,[t[0]||(t[0]=e("div",{class:"version-label"},"当前版本",-1)),e("div",$,h(n.value),1)])]),e("div",O,[!o.value&&!s.value&&!c.value&&!a.value?(m(),p("button",{key:0,class:"check-btn",onClick:y},[...t[2]||(t[2]=[e("svg",{viewBox:"0 0 24 24"},[e("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"})],-1),C(" 检查更新 ",-1)])])):_("",!0),o.value?(m(),p("div",F,[...t[3]||(t[3]=[e("div",{class:"loading-spinner"},null,-1),e("div",{class:"checking-text"},"正在检查更新...",-1)])])):_("",!0),!o.value&&!s.value&&!c.value&&a.value?(m(),p("div",j,[...t[4]||(t[4]=[e("div",{class:"latest-icon"},"✓",-1),e("div",{class:"latest-text"},"已是最新版本",-1)])])):_("",!0),c.value?(m(),p("div",Y,[t[5]||(t[5]=e("svg",{viewBox:"0 0 24 24"},[e("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"})],-1)),e("div",null,h(c.value),1),e("button",{class:"retry-btn",onClick:y},"重试")])):_("",!0)]),s.value?(m(),p("div",W,[e("div",X,[t[6]||(t[6]=e("div",{class:"update-badge"},"发现新版本",-1)),e("div",q,h(s.value.latestVersion),1)]),e("div",J,[e("div",Q,[t[7]||(t[7]=e("span",{class:"detail-label"},"发布日期:",-1)),e("span",Z,h(w(D)(s.value.publishedAt)),1)]),e("div",ee,[t[8]||(t[8]=e("span",{class:"detail-label"},"文件大小:",-1)),e("span",se,h(w(k)(s.value.fileSize)),1)])]),e("div",te,[t[9]||(t[9]=e("div",{class:"update-log-title"},"更新日志",-1)),e("div",oe,h(s.value.updateLog||"暂无更新日志"),1)]),!d.value&&!i.value?(m(),p("div",ae,[e("button",{class:"download-btn",onClick:S},[...t[10]||(t[10]=[e("svg",{viewBox:"0 0 24 24"},[e("path",{d:"M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"})],-1),C(" 立即下载更新 ",-1)])]),e("a",{href:s.value.releaseUrl,target:"_blank",class:"view-release-link"}," 在 GitHub 查看 ",8,le)])):_("",!0),d.value?(m(),p("div",ne,[e("div",re,[t[11]||(t[11]=e("span",null,"下载中...",-1)),e("span",null,h(r.value)+"%",1)]),e("div",ie,[e("div",{class:"progress-fill",style:N({width:r.value+"%"})},null,4)]),e("div",ce,h(w(k)(f.value))+" / "+h(w(k)(s.value.fileSize)),1)])):_("",!0),i.value?(m(),p("div",de,[...t[12]||(t[12]=[e("div",{class:"complete-icon"},"✓",-1),e("div",{class:"complete-text"},"已打开下载页面",-1),e("div",{class:"complete-hint"},'请在浏览器中完成下载。Android 用户可在"文件管理器"的"下载"文件夹找到 APK 文件',-1)])])):_("",!0)])):_("",!0)])]))}},_e=U(ue,[["__scopeId","data-v-0455da9e"]]);export{_e as default};
